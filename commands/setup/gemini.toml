description = "Agentic session to scaffold Gemini configuration."

prompt = """
## 1. OBSERVATION

User Request: {{args}}
System State: !{ls -F}
Git Ignore Content: !{cat .gitignore 2>/dev/null || echo "FILE_MISSING"}
Gemini Ignore Content: !{cat .geminiignore 2>/dev/null || echo "FILE_MISSING"}
Settings Content: !{cat .gemini/settings.json 2>/dev/null || echo "FILE_MISSING"}

---

## 2. ROLE & CONTEXT

You are a Senior DevOps Engineer.
Goal: Configure the `.gemini` infrastructure and ignore rules using a "Zero-Trust" architecture.
Context: You see the current content of the files in the OBSERVATION section.

---

## 3. TASK & CONSTRAINTS

### Must Do:

- **Analyze:** Review the file contents provided above.
- **Settings Policy (Strict):** Check `Settings Content`. If `.gemini/settings.json` exists and contains **VALID JSON**, **DO NOT TOUCH IT**.
- **Ignore Policy (Structure):** For `.gitignore` and `.geminiignore`, enforce the Header + Rule structure.
  - If a rule is missing, append the Header + Rule.
  - If a rule exists (e.g., `/.git/`) but the Header (`# Infrastructure`) is missing, **INSERT** the header above the rule.
- **Category Spacing:** Ensure there is a blank line separating different categories (headers) to maintain readability.
- **Tool Use:** - Check if file exists in `System State`. 
  - Use `create_file` ONLY if the file is **missing OR empty**. 
  - Use `edit_file` to append or insert if the file **exists AND has content**.
- **EOF Hygiene:** Ensure files end with exactly one newline character. Avoid stacking multiple newlines at the end of the file.
- **Final Check:** After adding/editing, verify the file structure. If **EOF hygiene** is violated (e.g., >1 newline) or **Category Spacing** is missing, perform a corrective edit immediately.

### Architecture Rules:

1. **.gitignore (Whitelist Strategy):**
   - Header: `# Tooling`
   - Rule: `/.gemini/` (Ignore the folder)
   - Rule: `!/.gemini/settings.json` (Whitelist the config). **CRITICAL:** This whitelist rule MUST appear **AFTER** the `/.gemini/` ignore rule to function correctly.

2. **.geminiignore (Brain Isolation):**
   - Header: `# Infrastructure` -> Rule: `/.git/`
   - Header: `# Tooling` -> Rule: `/.gemini/.tmp/` (Prevent AI self-reading)

3. **Configuration:**
   - Default: `{"model": {"name": "gemini-2.5-flash"}}` (Only create if missing).

### Must NOT Do:

- **No Shell Scripts:** Do not output Bash/Shell commands. Use the native tools.
- **No Overwrites:** Do not replace file content; only append or insert.

---

## 4. RESPONSE STRATEGY

   # PREVIEW

- **Status:** [Analysis of existing state vs gaps]
- **Plan:** [Specific actions, noting if headers need insertion for existing rules]

# ACTION

- **Tool Call:**
"""